---
title: MySQL的时间相关类型和函数总结
date: 2023-02-11 06:52:56 +0800
categories: [数据分析,SQL学习]
tags: [SQL,时间函数]
math: true
mermaid: true
---

在做数据分析时，处理时间序列数据是非常重要的一环，会面临多种多样的时间序列需求。时间作为SQL数据库中特殊数据类型，存在多种内置函数，因此掌握这样的函数非常必要，因此我根据[**MySQL的最新官方手册**](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-types.html)总结了MySQL中的时间相关类型和内置函数，归档留存，以备后续查询。

> 本文章只讨论MySQL相关的类型和内置函数，其他数据库可能存在部分差异。
{: .prompt-warning }
> 由于SQL语句无视大小写，为了个人阅读方便，此处均使用小写。
{: .prompt-info }

## MySQL的时间相关数据类型

MySQL的时间相关数据类型有五种：
1. date 
  + 精确到日期，数据格式为 `YYYY-MM-DD`
  + 范围为 `1000-01-01`到`9999-12-31`
  + 占用3个字节

2. datetime
  + 从年份开始精确到秒，数据格式为 `YYYY-MM-DD HH:MM:SS`
  + 范围为 `1000-01-01 00:00:00`到`9999-12-31 23:59:59`
  + 占用8个字节
  + 允许秒处精确到小数0~6位，但需定义时规定`datetime(6)`

3. timestamp
  + 从年份开始精确到秒，数据格式为 `YYYYMMDDHHMMSS`
  + 范围为 `1970-01-01 00:00:01`到`2038-01-19 03:14:07`
  + 占用4个字节，相比datetime占用空间较少，因此范围较近
  + 允许秒处精确到小数0~6位，但需定义时规定`timestamp(6)`

4. time
  + 仅存储时间信息，不仅可以表示一天的时间，也可以表示时间间隔，数据格式为 `HH:MM:SS`
  + 范围为 `-838:59:59`到`838:59:59`
  + 占用3个字节
  + 允许秒处精确到小数0~6位，但需定义时规定`time(6)`

5. year
  + 只存储年份，数据格式为`YYYY`
  + 范围为 `1901`到`2155`
  + 占用1个字节

MySQL允许使用字符串或数字直接转换为日期类型，可以直接赋值，并遵循以下规则：

- 若格式为字符串，只要满足格式`YYYY-MM-DD hh:mm:ss`即可，其中分隔符也可以用不同的分隔符，例如`2012^12^31 11+30+45`，只要其中的数值符合规定，就可以直接转换为相应的时间类型。

- 数值格式同样如此，例如`19830905132800`和`830905132800`被解释为`1983-09-05 13:28:00`。

- 若赋值的数值存在小数，则必须包含小数点，小数点分隔符是必须的。

- 若赋值内容非法，则将此数值转换为全0数值，例如`071332`会变成`0000-00-00`。

## 时间相关函数

1. 获取当前日期和时间函数
  + `now()` 获取当前日期和时间
  + `curdate()` 获取当前日期
  + `curtime()` 获取当前时间

2. 根据时间提取其中数值或字符串
  + `year()` 年
  + `month()` 月
  + `day()` 日
  + `hour()` 时
  + `minute()` 分
  + `second()` 秒
  + `dayname()` 星期几(英文)
  + `monthname()` 月份(英文)

3. 格式化日期和时间
  + `date_format(time,'%Y-%m-%d')` 格式化日期
  + `time_format(time,'%h:%i:%s')` 格式化时间
  + 可以随意组合想要格式化的内容
  + `%Y` 年，2位年份，如`1999` &nbsp;&nbsp; `%y` 年，2位年份，如`99`
  + `%M` 月，月份英文名，如`January` &nbsp;&nbsp; `%m` 月，数值月份，如`01`
  + `%D` 日，带有英文后缀，如`2nd` &nbsp;&nbsp; `%d` 日，数值日期，如`02`
  + `%H` 小时，范围为0～24，如`15` &nbsp;&nbsp; `%h` 小时，范围为01～12，如`03`
  + `%i` 分钟，范围为00～59
  + `%s` 秒，范围为00～59

4. 时间运算
  + `date_add(time,timeInterval)` 增加时间，time为需要操作的时间，timeInterval为对当前时间增加的数值。具体的写法为`date_add('2023-02-11', INTERVAL 1 DAY)`
  + `date_sub(time,timeInterval)` 减少时间，具体写法和参数同上
  + 这里的timeInterval可以是年月日时分秒，只需在`INTERVAL 1 DAY`中将`DAY`替换为相应的名称即可。
  + `period_add(time, N)` 增加N个月份
  + `period_sub(time, N)` 减少N个月份

5. 时间间隔运算
  + `period_diff(P1,P2)` 计算日期P1和P2相差的月份，返回N个月份，可以是负数
  + `datediff(date1,date2)` 计算日期date1和date2相差的月份，返回N天，可以是负数
  + `timediff(time1,time2)` 计算时间time1和time2相差的时间，返回time类型的差值，例如`timediff('2021-08-31 19:22:31', '2021-08-31 17:00:00')`返回值是`02:22:31`
  + `timestampdiff(timeType, time1,time2)` 时间戳计算是最强大的计算方式，
  <span style="color:red;">与前面的diff不同，此处计算时间间隔方式为time2 - time1的间隔。</span> 通过改变timeType可以知晓每种间隔时间，例如`timestampdiff(year, '2017-06-01', '2016-05-15')`返回值为-1，其中year可以替换为month、day、hour等，<span style="color:red;">此处必须为时间类型timestamp</span>

6. 时间转换
  + `time_to_sec('01:00:05')` 无视日期，将后面的时间转换为秒数
  + `sec_to_time(3605)` 将秒数转换为时间
  + `to_days('2017-06-05')` 无视时间，将日期转换为天数，此处的天数是从起始时间`0000-00-00`到现在的天数
  + `from_days(736850)` 将天数转换为日期

## 时间相关处理技巧

+ 可以在直接使用`time > '2023-02-11'`这样的筛选方式，这样会筛选出2023-02-11后的数据。

+ sum()和avg()聚合函数不能处理时间值。要解决这个问题，请将其转换为数字，然后执行聚合操作，最后将其转换回时间值。例如：

```sql
-- 聚合时间
select 
  sec_to_time(sum(time_to_sec(time_col))) 
from 
  tbl_name;

-- 聚合日期
select 
  from_dats(SUM(to_days(date_col))) 
from 
  tbl_name;
```

+ 后续补充中...
